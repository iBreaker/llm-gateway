# æ•°æ®åº“æ¶æ„é‡æ„è¯´æ˜

## ğŸ¯ é‡æ„ç›®æ ‡

è§£å†³åŸæ¶æ„ä¸­çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **æ•°æ®è¡¨ç»“æ„é‡å¤å®šä¹‰** - åœ¨ä¸åŒé€‚é…å™¨ä¸­é‡å¤å®šä¹‰ç›¸åŒçš„è¡¨ç»“æ„
2. **é€‚é…å™¨ä¸šåŠ¡è€¦åˆ** - é€‚é…å™¨åŒ…å«äº†ä¸šåŠ¡ç›¸å…³çš„æ–¹æ³•

## ğŸ“Š æ¶æ„å¯¹æ¯”

### âŒ é‡æ„å‰çš„é—®é¢˜

```
src/lib/adapters/database/
â”œâ”€â”€ sqlite.ts          # åŒ…å«è¡¨ç»“æ„ + ä¸šåŠ¡æ–¹æ³•
â”œâ”€â”€ postgres.ts        # åŒ…å«è¡¨ç»“æ„ + ä¸šåŠ¡æ–¹æ³•  
â””â”€â”€ supabase.ts        # åŒ…å«è¡¨ç»“æ„ + ä¸šåŠ¡æ–¹æ³•

é—®é¢˜ï¼š
- è¡¨ç»“æ„åœ¨æ¯ä¸ªé€‚é…å™¨ä¸­é‡å¤å®šä¹‰
- é€‚é…å™¨åŒ…å« createUserã€getApiKeyByHash ç­‰ä¸šåŠ¡æ–¹æ³•
- è¿åå•ä¸€èŒè´£åŸåˆ™å’Œ DRY åŸåˆ™
```

### âœ… é‡æ„åçš„æ¶æ„

```
src/lib/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ schemas/                    # ğŸ“ ç»Ÿä¸€çš„æ•°æ®ç»“æ„ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ tables.sql             # è¡¨ç»“æ„å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ indexes.sql            # ç´¢å¼•å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ triggers.sql           # è§¦å‘å™¨å®šä¹‰
â”‚   â”‚   â””â”€â”€ migration-manager.ts   # è¿ç§»ç®¡ç†å™¨
â”‚   â””â”€â”€ repositories/               # ğŸ“ ä¸šåŠ¡æ•°æ®è®¿é—®å±‚
â”‚       â”œâ”€â”€ user-repository.ts     # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”‚       â”œâ”€â”€ api-key-repository.ts  # API å¯†é’¥ä¸šåŠ¡é€»è¾‘
â”‚       â””â”€â”€ index.ts               # Repository å·¥å‚
â”œâ”€â”€ adapters/database/              # ğŸ“ çº¯ç²¹çš„æ•°æ®è®¿é—®å±‚
â”‚   â”œâ”€â”€ sqlite.ts                  # åªåŒ…å« SQLite æŠ€æœ¯å®ç°
â”‚   â”œâ”€â”€ postgres.ts                # åªåŒ…å« PostgreSQL æŠ€æœ¯å®ç°
â”‚   â””â”€â”€ supabase-clean.ts          # åªåŒ…å« Supabase æŠ€æœ¯å®ç°
â””â”€â”€ interfaces/repositories/       # ğŸ“ ä¸šåŠ¡æ¥å£å®šä¹‰
    â”œâ”€â”€ base.ts                    # åŸºç¡€ Repository æ¥å£
    â”œâ”€â”€ user-repository.ts         # ç”¨æˆ· Repository æ¥å£
    â””â”€â”€ api-key-repository.ts      # API å¯†é’¥ Repository æ¥å£
```

## ğŸ—ï¸ æ–°æ¶æ„å±‚çº§

### 1. **Schema å±‚** - æ•°æ®ç»“æ„ç®¡ç†
- **èŒè´£**ï¼šç»Ÿä¸€ç®¡ç†æ•°æ®è¡¨ç»“æ„ã€ç´¢å¼•ã€è§¦å‘å™¨
- **ä½ç½®**ï¼š`src/lib/db/schemas/`
- **ä¼˜åŠ¿**ï¼šä¸€å¤„å®šä¹‰ï¼Œå¤„å¤„ä½¿ç”¨ï¼Œç¡®ä¿ä¸€è‡´æ€§

### 2. **Adapter å±‚** - æŠ€æœ¯å®ç°
- **èŒè´£**ï¼šæä¾›çº¯ç²¹çš„æ•°æ®åº“æ“ä½œæ¥å£
- **æ–¹æ³•**ï¼š`findOne`ã€`findMany`ã€`create`ã€`update`ã€`delete`
- **ç‰¹ç‚¹**ï¼šæ— ä¸šåŠ¡é€»è¾‘ï¼Œå¯æ›¿æ¢

### 3. **Repository å±‚** - ä¸šåŠ¡æ•°æ®è®¿é—®
- **èŒè´£**ï¼šå¤„ç†ä¸šåŠ¡ç›¸å…³çš„æ•°æ®è®¿é—®é€»è¾‘
- **æ–¹æ³•**ï¼š`findByEmail`ã€`emailExists`ã€`findActiveUsers`
- **ç‰¹ç‚¹**ï¼šå°è£…ä¸šåŠ¡è§„åˆ™ï¼Œä½¿ç”¨é€‚é…å™¨çš„åŸºç¡€æ¥å£

### 4. **Service å±‚** - ä¸šåŠ¡é€»è¾‘
- **èŒè´£**ï¼šåè°ƒå¤šä¸ª Repositoryï¼Œå¤„ç†å¤æ‚ä¸šåŠ¡é€»è¾‘
- **ç¤ºä¾‹**ï¼šç”¨æˆ·æ³¨å†Œã€è®¤è¯ã€æƒé™éªŒè¯

## ğŸ“ˆ æ¶æ„ä¼˜åŠ¿

### 1. **å…³æ³¨ç‚¹åˆ†ç¦»**
- é€‚é…å™¨ä¸“æ³¨æŠ€æœ¯å®ç°
- Repository å¤„ç†ä¸šåŠ¡é€»è¾‘
- Schema ç®¡ç†æ•°æ®ç»“æ„

### 2. **DRY åŸåˆ™**
- è¡¨ç»“æ„åªå®šä¹‰ä¸€æ¬¡
- ä¸šåŠ¡æ–¹æ³•ä¸åœ¨é€‚é…å™¨ä¸­é‡å¤

### 3. **å¯ç»´æŠ¤æ€§**
- ä¿®æ”¹è¡¨ç»“æ„åªéœ€æ›´æ–°ä¸€ä¸ªåœ°æ–¹
- ä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨ Repository å±‚

### 4. **å¯æµ‹è¯•æ€§**
- æ¯å±‚éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
- Repository å¯ä»¥ä½¿ç”¨ Mock é€‚é…å™¨æµ‹è¯•

### 5. **æ‰©å±•æ€§**
- æ–°å¢æ•°æ®åº“é€‚é…å™¨æ— éœ€é‡å¤å®ç°ä¸šåŠ¡æ–¹æ³•
- æ–°å¢ä¸šåŠ¡åŠŸèƒ½åªéœ€æ‰©å±• Repository

## ğŸ”„ è¿ç§»æŒ‡å—

### æ—§ä»£ç æ¨¡å¼
```typescript
// âŒ ç›´æ¥ä½¿ç”¨é€‚é…å™¨çš„ä¸šåŠ¡æ–¹æ³•
const user = await adapter.createUser({
  email: 'test@example.com',
  username: 'testuser',
  passwordHash: 'hash123'
})
```

### æ–°ä»£ç æ¨¡å¼
```typescript
// âœ… ä½¿ç”¨ Repository å±‚
const userRepo = repositoryFactory.createUserRepository()
const user = await userRepo.create({
  email: 'test@example.com',
  username: 'testuser',
  passwordHash: 'hash123'
})
```

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. **é€‚é…å™¨è®¾è®¡**
- åªæä¾›åŸºç¡€ CRUD æ“ä½œ
- ä¸åŒ…å«ä»»ä½•ä¸šåŠ¡é€»è¾‘
- æ”¯æŒäº‹åŠ¡å’ŒåŸç”Ÿ SQL

### 2. **Repository è®¾è®¡**
- å®ç°ç‰¹å®šçš„ä¸šåŠ¡æ¥å£
- å°è£…å¤æ‚çš„æŸ¥è¯¢é€»è¾‘
- å¤„ç†æ•°æ®éªŒè¯

### 3. **Schema ç®¡ç†**
- ä½¿ç”¨ SQL æ–‡ä»¶å®šä¹‰ç»“æ„
- é€šè¿‡ MigrationManager ç»Ÿä¸€æ‰§è¡Œ
- ç‰ˆæœ¬åŒ–ç®¡ç†æ•°æ®åº“å˜æ›´

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

```typescript
// åˆå§‹åŒ–
const databaseService = new DatabaseService()
await databaseService.initialize(config)

// è·å– Repository
const userRepo = databaseService.getRepositoryFactory().createUserRepository()

// ä¸šåŠ¡æ“ä½œ
const user = await userRepo.create({ ... })
const users = await userRepo.findActiveUsers()
const exists = await userRepo.emailExists('test@example.com')
```

## ğŸ‰ æ€»ç»“

è¿™æ¬¡é‡æ„å®Œå…¨è§£å†³äº†æ‚¨æå‡ºçš„ä¸¤ä¸ªé—®é¢˜ï¼š
1. âœ… æ•°æ®è¡¨ç»“æ„ç°åœ¨ç»Ÿä¸€ç®¡ç†åœ¨ `schemas/` ç›®å½•
2. âœ… é€‚é…å™¨ç°åœ¨æ˜¯çº¯ç²¹çš„æŠ€æœ¯å®ç°ï¼Œä¸åŒ…å«ä¸šåŠ¡é€»è¾‘

æ–°æ¶æ„æä¾›äº†æ›´å¥½çš„å¯ç»´æŠ¤æ€§ã€å¯æµ‹è¯•æ€§å’Œæ‰©å±•æ€§ï¼Œç¬¦åˆè½¯ä»¶å·¥ç¨‹çš„æœ€ä½³å®è·µã€‚